<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××¢×¨×›×ª × ×™×”×•×œ ×§×•×¤×•× ×™×</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .file-upload-section {
            padding: 30px;
            background-color: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
        }

        .file-upload-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }

        .file-upload-box {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 2px dashed #667eea;
            text-align: center;
            transition: all 0.3s ease;
        }

        .file-upload-box:hover {
            border-color: #764ba2;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .file-upload-box h3 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .file-upload-box input[type="file"] {
            display: none;
        }

        .file-upload-box label {
            display: inline-block;
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .file-upload-box label:hover {
            transform: translateY(-2px);
        }

        .file-status {
            margin-top: 10px;
            font-size: 14px;
        }

        .file-status.success {
            color: #2ed573;
        }

        .file-status.error {
            color: #ff6348;
        }

        .process-button {
            display: block;
            margin: 0 auto;
            padding: 15px 40px;
            background: linear-gradient(135deg, #2ed573 0%, #26d162 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .process-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(46, 213, 115, 0.4);
        }

        .process-button:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }

        .controls {
            padding: 20px 30px;
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .search-filters {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 1fr;
            gap: 15px;
        }

        .search-box {
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 12px 45px 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .search-box input:focus {
            outline: none;
            border-color: #667eea;
        }

        .search-box .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
        }

        select, button {
            padding: 12px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            background-color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        select:focus, button:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            font-weight: bold;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 20px;
            padding: 30px;
            background-color: #f8f9fa;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            text-align: center;
        }

        .stat-card h3 {
            color: #667eea;
            font-size: 1em;
            margin-bottom: 10px;
        }

        .stat-card .number {
            font-size: 2em;
            font-weight: bold;
            color: #333;
        }

        .results-section {
            padding: 30px;
            display: none;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: right;
            font-weight: bold;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        tr:hover {
            background-color: #f8f9fa;
        }

        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
        }

        .status-critical { background-color: #ff4757; color: white; }
        .status-near { background-color: #ffa502; color: white; }
        .status-progressing { background-color: #3742fa; color: white; }
        .status-far { background-color: #747d8c; color: white; }

        .year-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 13px;
            font-weight: bold;
            margin-right: 5px;
        }

        .year-a { background-color: #e8f5e9; color: #2e7d32; }
        .year-b { background-color: #e3f2fd; color: #1565c0; }
        .year-c { background-color: #f3e5f5; color: #7b1fa2; }
        .year-d { background-color: #fff3e0; color: #e65100; }
        .year-mil { background-color: #ffebee; color: #c62828; }

        .no-results {
            text-align: center;
            padding: 50px;
            font-size: 1.1em;
            color: #999;
        }

        .debug-info {
            background-color: #f0f0f0;
            padding: 15px;
            margin: 20px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>××¢×¨×›×ª × ×™×”×•×œ ×§×•×¤×•× ×™×</h1>
            <p>×”×¢×œ×” ××ª ×”×§×‘×¦×™× ×”× ×“×¨×©×™× ×œ×¢×™×‘×•×“ ×”× ×ª×•× ×™×</p>
        </div>

        <div class="file-upload-section">
            <div class="file-upload-grid">
                <div class="file-upload-box">
                    <h3>×§×•×‘×¥ ××©×ª×ª×¤×™× ×•×¦×™×•× ×™×</h3>
                    <p style="font-size: 12px; color: #666; margin: 10px 0;">×§×•×‘×¥ Zins ×¢× ×¨×©×™××ª ×”×¡×˜×•×“× ×˜×™× ×•×”×¦×™×•× ×™×</p>
                    <label for="participantsFile">
                        ğŸ“ ×‘×—×¨ ×§×•×‘×¥
                        <input type="file" id="participantsFile" accept=".xlsx,.xls,.csv">
                    </label>
                    <div class="file-status" id="participantsStatus"></div>
                </div>
                
                <div class="file-upload-box">
                    <h3>×§×•×‘×¥ ×§×•×¤×•× ×™×</h3>
                    <p style="font-size: 12px; color: #666; margin: 10px 0;">×§×•×‘×¥ ×¢× ××¡×¤×¨ ×”×§×•×¤×•× ×™× ×©×¦×‘×¨ ×›×œ ×¡×˜×•×“× ×˜</p>
                    <label for="couponsFile">
                        ğŸŸï¸ ×‘×—×¨ ×§×•×‘×¥
                        <input type="file" id="couponsFile" accept=".xlsx,.xls,.csv">
                    </label>
                    <div class="file-status" id="couponsStatus"></div>
                </div>

                <div class="file-upload-box">
                    <h3>×§×•×‘×¥ ×©× ×™×</h3>
                    <p style="font-size: 12px; color: #666; margin: 10px 0;">×§×•×‘×¥ ×¢× ×”×©× ×” ×”×¤×“×’×•×’×™×ª ×©×œ ×›×œ ×¡×˜×•×“× ×˜</p>
                    <label for="yearsFile">
                        ğŸ“… ×‘×—×¨ ×§×•×‘×¥
                        <input type="file" id="yearsFile" accept=".xlsx,.xls,.csv">
                    </label>
                    <div class="file-status" id="yearsStatus"></div>
                </div>
            </div>
            
            <button class="process-button" id="processButton" onclick="processFiles()" disabled>
                ×¢×‘×“ ××ª ×”×§×‘×¦×™×
            </button>
        </div>

        <div class="controls" style="display: none;" id="controlsSection">
            <div class="search-filters">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="×—×™×¤×•×© ×—×•×¤×©×™ - ×©×, ×ª.×–, ××™×™×œ...">
                    <span class="search-icon">ğŸ”</span>
                </div>
                <select id="statusFilter">
                    <option value="">×›×œ ×”×¡×˜×˜×•×¡×™×</option>
                    <option value="critical">×“×—×•×£</option>
                    <option value="near">×§×¨×•×‘ ×œ×¡×£</option>
                    <option value="progressing">×‘×“×¨×š ×œ×¡×£</option>
                    <option value="far">×¨×—×•×§ ××”×¡×£</option>
                </select>
                <select id="yearFilter">
                    <option value="">×›×œ ×”×©× ×™×</option>
                    <option value="×">×©× ×” ×'</option>
                    <option value="×‘">×©× ×” ×‘'</option>
                    <option value="×’">×©× ×” ×’'</option>
                    <option value="×“">×©× ×” ×“'</option>
                    <option value="××™×œ">××™×œ×•××™×</option>
                </select>
                <select id="sortBy">
                    <option value="name">××™×•×Ÿ ×œ×¤×™ ×©×</option>
                    <option value="coupons">××™×•×Ÿ ×œ×¤×™ ×§×•×¤×•× ×™×</option>
                    <option value="status">××™×•×Ÿ ×œ×¤×™ ×¡×˜×˜×•×¡</option>
                    <option value="year">××™×•×Ÿ ×œ×¤×™ ×©× ×”</option>
                </select>
                <button onclick="applyFilters()">ğŸ” ×¡× ×Ÿ ×•×—×¤×©</button>
            </div>
        </div>

        <div class="stats-container" style="display: none;" id="statsContainer">
            <div class="stat-card">
                <h3>×¡×”"×› ×¡×˜×•×“× ×˜×™×</h3>
                <div class="number" id="totalStudents">0</div>
            </div>
            <div class="stat-card">
                <h3>×“×—×•×£</h3>
                <div class="number" id="criticalCount">0</div>
            </div>
            <div class="stat-card">
                <h3>×§×¨×•×‘ ×œ×¡×£</h3>
                <div class="number" id="nearCount">0</div>
            </div>
            <div class="stat-card">
                <h3>×‘×“×¨×š ×œ×¡×£</h3>
                <div class="number" id="progressingCount">0</div>
            </div>
            <div class="stat-card">
                <h3>×¨×—×•×§ ××”×¡×£</h3>
                <div class="number" id="farCount">0</div>
            </div>
        </div>

        <div class="debug-info" id="debugInfo"></div>

        <div class="results-section" id="resultsSection">
            <div class="table-container">
                <table id="studentsTable">
                    <thead>
                        <tr>
                            <th>×©× ××œ×</th>
                            <th>×ª.×–</th>
                            <th>××™×™×œ</th>
                            <th>×©× ×”</th>
                            <th>×§×•×¤×•× ×™×</th>
                            <th>×¦×™×•×Ÿ</th>
                            <th>×¡×˜×˜×•×¡</th>
                        </tr>
                    </thead>
                    <tbody id="studentsTableBody">
                    </tbody>
                </table>
                <div id="noResults" class="no-results" style="display: none;">
                    ×œ× × ××¦××• ×ª×•×¦××•×ª ×”×ª×•×××•×ª ×œ×—×™×¤×•×©
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        let participants = [];
        let couponsData = {};
        let yearsData = {};
        let students = [];
        let filesUploaded = {
            participants: false,
            coupons: false,
            years: false
        };

        // File upload handlers
        document.getElementById('participantsFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('participantsStatus').textContent = '×˜×•×¢×Ÿ...';
                document.getElementById('participantsStatus').className = 'file-status';
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
                        
                        // Process Zins file - skip header rows
                        participants = [];
                        for (let i = 2; i < jsonData.length; i++) {
                            const row = jsonData[i];
                            if (row[1] && row[2]) { // Check if name and ID exist
                                participants.push({
                                    name: row[1].toString().trim(),
                                    id: row[2].toString().trim(),
                                    grade: row[5] || '××™×Ÿ ×¦×™×•×Ÿ'
                                });
                            }
                        }
                        
                        filesUploaded.participants = true;
                        document.getElementById('participantsStatus').textContent = `âœ“ ${participants.length} ××©×ª×ª×¤×™× × ×˜×¢× ×•`;
                        document.getElementById('participantsStatus').className = 'file-status success';
                        checkAllFiles();
                    } catch (error) {
                        document.getElementById('participantsStatus').textContent = 'âŒ ×©×’×™××” ×‘×§×¨×™××ª ×”×§×•×‘×¥';
                        document.getElementById('participantsStatus').className = 'file-status error';
                        console.error('Error:', error);
                    }
                };
                reader.readAsArrayBuffer(file);
            }
        });

        document.getElementById('couponsFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('couponsStatus').textContent = '×˜×•×¢×Ÿ...';
                document.getElementById('couponsStatus').className = 'file-status';
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const couponsArray = XLSX.utils.sheet_to_json(firstSheet);
                        
                        // Process coupons data - new format
                        couponsData = {};
                        couponsArray.forEach(row => {
                            const email = row['Email'];
                            const loginId = row['Login ID']?.toString();
                            const coupons = row['Credits Earned for Course'] || 0;
                            
                            if (email) {
                                couponsData[email.toLowerCase()] = parseFloat(coupons);
                            }
                            if (loginId) {
                                couponsData[loginId] = parseFloat(coupons);
                            }
                        });
                        
                        filesUploaded.coupons = true;
                        const uniqueStudents = new Set(Object.keys(couponsData).filter(key => key.includes('@'))).size;
                        document.getElementById('couponsStatus').textContent = `âœ“ ${uniqueStudents} ×¡×˜×•×“× ×˜×™× ×¢× ×§×•×¤×•× ×™×`;
                        document.getElementById('couponsStatus').className = 'file-status success';
                        checkAllFiles();
                    } catch (error) {
                        document.getElementById('couponsStatus').textContent = 'âŒ ×©×’×™××” ×‘×§×¨×™××ª ×”×§×•×‘×¥';
                        document.getElementById('couponsStatus').className = 'file-status error';
                        console.error('Error:', error);
                    }
                };
                reader.readAsArrayBuffer(file);
            }
        });

        document.getElementById('yearsFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('yearsStatus').textContent = '×˜×•×¢×Ÿ...';
                document.getElementById('yearsStatus').className = 'file-status';
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const yearsArray = XLSX.utils.sheet_to_json(firstSheet);
                        
                        // Process years data
                        yearsData = {};
                        yearsArray.forEach(row => {
                            const name = row['×›×•×ª×¨×ª ×¢×‘×¨×™×ª']?.trim();
                            const id = row['×›×•×ª×¨×ª ×¢×‘×¨×™×ª_1']?.toString().trim();
                            const year = row['×©× ×” ×¤×“×’×•×’×™×ª:']?.trim();
                            
                            if (name && year) {
                                yearsData[name] = year;
                            }
                            if (id && year) {
                                yearsData[id] = year;
                            }
                        });
                        
                        filesUploaded.years = true;
                        const uniqueEntries = new Set(Object.values(yearsData)).size;
                        document.getElementById('yearsStatus').textContent = `âœ“ ${Object.keys(yearsData).length / 2} ×¡×˜×•×“× ×˜×™× ×¢× × ×ª×•× ×™ ×©× ×”`;
                        document.getElementById('yearsStatus').className = 'file-status success';
                        checkAllFiles();
                    } catch (error) {
                        document.getElementById('yearsStatus').textContent = 'âŒ ×©×’×™××” ×‘×§×¨×™××ª ×”×§×•×‘×¥';
                        document.getElementById('yearsStatus').className = 'file-status error';
                        console.error('Error:', error);
                    }
                };
                reader.readAsArrayBuffer(file);
            }
        });

        function checkAllFiles() {
            if (filesUploaded.participants && filesUploaded.coupons && filesUploaded.years) {
                document.getElementById('processButton').disabled = false;
            }
        }

        function getStudentYear(name, id) {
            // Try to match by ID first (more reliable)
            if (id && yearsData[id]) {
                return yearsData[id];
            }
            
            // Try to match by name
            if (name && yearsData[name]) {
                return yearsData[name];
            }
            
            // Try different name formats
            if (name) {
                // Remove extra spaces
                const cleanName = name.replace(/\s+/g, ' ').trim();
                if (yearsData[cleanName]) {
                    return yearsData[cleanName];
                }
                
                // Try swapping first and last name
                const parts = cleanName.split(' ');
                if (parts.length === 2) {
                    const reversedName = `${parts[1]} ${parts[0]}`;
                    if (yearsData[reversedName]) {
                        return yearsData[reversedName];
                    }
                }
            }
            
            return '×'; // Default to year × if not found
        }

        function getRequiredCoupons(year) {
            if (!year) return 30;
            
            // Check if it's ××™×œ×•××™×
            if (year.includes('*××™×œ*')) {
                return 18;
            }
            
            // Check the year letter
            const yearLetter = year.trim().charAt(0);
            if (yearLetter === '×') {
                return 30;
            } else {
                return 24; // ×©× ×” ×‘, ×’, ×“
            }
        }

        function getStatus(coupons, year) {
            const required = getRequiredCoupons(year);
            
            if (year.includes('*××™×œ*')) {
                // ××™×œ×•××™× thresholds
                if (coupons >= 18) return 'critical';
                if (coupons >= 12) return 'near';
                if (coupons >= 10) return 'progressing';
                return 'far';
            } else if (required === 30) {
                // ×©× ×” × thresholds
                if (coupons >= 30) return 'critical';
                if (coupons >= 24) return 'near';
                if (coupons >= 18) return 'progressing';
                return 'far';
            } else {
                // ×©× ×” ×‘, ×’, ×“ thresholds
                if (coupons >= 24) return 'critical';
                if (coupons >= 18) return 'near';
                if (coupons >= 12) return 'progressing';
                return 'far';
            }
        }

        function getStatusText(status) {
            switch(status) {
                case 'critical': return '×“×—×•×£';
                case 'near': return '×§×¨×•×‘ ×œ×¡×£';
                case 'progressing': return '×‘×“×¨×š ×œ×¡×£';
                case 'far': return '×¨×—×•×§ ××”×¡×£';
                default: return '×œ× ×™×“×•×¢';
            }
        }

        function getYearBadgeClass(year) {
            if (!year) return 'year-a';
            
            if (year.includes('*××™×œ*')) return 'year-mil';
            
            const yearLetter = year.trim().charAt(0);
            switch(yearLetter) {
                case '×': return 'year-a';
                case '×‘': return 'year-b';
                case '×’': return 'year-c';
                case '×“': return 'year-d';
                default: return 'year-a';
            }
        }

        function findStudentEmail(participant) {
            // Try to find email in coupons data by matching ID
            for (const [key, value] of Object.entries(couponsData)) {
                if (key === participant.id) {
                    // Find the corresponding email
                    for (const [emailKey, emailValue] of Object.entries(couponsData)) {
                        if (emailKey.includes('@') && emailValue === value) {
                            return emailKey;
                        }
                    }
                }
            }
            return '';
        }

        function processFiles() {
            students = [];
            
            // Debug info
            console.log('Processing files...');
            console.log('Participants:', participants.length);
            console.log('Coupons data entries:', Object.keys(couponsData).length);
            console.log('Years data entries:', Object.keys(yearsData).length);
            
            participants.forEach(participant => {
                const id = participant.id;
                const name = participant.name;
                const grade = participant.grade;
                
                // Get year
                const year = getStudentYear(name, id);
                
                // Get coupons - try by ID first
                let coupons = couponsData[id] || 0;
                
                // Find email
                const email = findStudentEmail(participant);
                
                // If we found email and no coupons by ID, try by email
                if (email && !coupons) {
                    coupons = couponsData[email] || 0;
                }
                
                // Extract names
                const nameParts = name.split(' ');
                const firstName = nameParts[1] || nameParts[0] || '';
                const lastName = nameParts[0] || '';
                
                students.push({
                    id: id,
                    name: name,
                    firstName: firstName,
                    lastName: lastName,
                    email: email,
                    grade: grade,
                    coupons: Math.floor(coupons), // Round down to whole number
                    year: year
                });
            });
            
            // Show results section
            document.getElementById('controlsSection').style.display = 'block';
            document.getElementById('statsContainer').style.display = 'grid';
            document.getElementById('resultsSection').style.display = 'block';
            
            updateStats();
            renderTable();
        }

        function updateStats() {
            const stats = {
                total: students.length,
                critical: 0,
                near: 0,
                progressing: 0,
                far: 0
            };

            students.forEach(student => {
                const status = getStatus(student.coupons, student.year);
                stats[status]++;
            });

            document.getElementById('totalStudents').textContent = stats.total;
            document.getElementById('criticalCount').textContent = stats.critical;
            document.getElementById('nearCount').textContent = stats.near;
            document.getElementById('progressingCount').textContent = stats.progressing;
            document.getElementById('farCount').textContent = stats.far;
        }

        function renderTable(filteredStudents = null) {
            const tbody = document.getElementById('studentsTableBody');
            const studentsToRender = filteredStudents || students;
            
            tbody.innerHTML = '';

            if (studentsToRender.length === 0) {
                document.getElementById('studentsTable').style.display = 'none';
                document.getElementById('noResults').style.display = 'block';
                return;
            }

            document.getElementById('studentsTable').style.display = 'table';
            document.getElementById('noResults').style.display = 'none';

            studentsToRender.forEach(student => {
                const status = getStatus(student.coupons, student.year);
                const yearBadgeClass = getYearBadgeClass(student.year);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${student.name}</td>
                    <td>${student.id}</td>
                    <td>${student.email || '×œ× × ××¦×'}</td>
                    <td><span class="year-badge ${yearBadgeClass}">${student.year}</span></td>
                    <td>${student.coupons}</td>
                    <td>${student.grade}</td>
                    <td><span class="status-badge status-${status}">${getStatusText(status)}</span></td>
                `;
                tbody.appendChild(row);
            });
        }

        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const yearFilter = document.getElementById('yearFilter').value;
            const sortBy = document.getElementById('sortBy').value;

            let filtered = students.filter(student => {
                const status = getStatus(student.coupons, student.year);
                
                // Free text search
                const searchMatch = !searchTerm || 
                    student.name.toLowerCase().includes(searchTerm) ||
                    student.firstName.toLowerCase().includes(searchTerm) ||
                    student.lastName.toLowerCase().includes(searchTerm) ||
                    student.id.includes(searchTerm) ||
                    student.email.toLowerCase().includes(searchTerm);
                
                // Status filter
                const statusMatch = !statusFilter || status === statusFilter;
                
                // Year filter
                let yearMatch = true;
                if (yearFilter) {
                    if (yearFilter === '××™×œ') {
                        yearMatch = student.year.includes('*××™×œ*');
                    } else {
                        yearMatch = student.year.trim().charAt(0) === yearFilter && !student.year.includes('*××™×œ*');
                    }
                }
                
                return searchMatch && statusMatch && yearMatch;
            });

            // Sort
            filtered.sort((a, b) => {
                switch(sortBy) {
                    case 'name':
                        return a.name.localeCompare(b.name);
                    case 'coupons':
                        return b.coupons - a.coupons;
                    case 'status':
                        const statusOrder = { 'critical': 0, 'near': 1, 'progressing': 2, 'far': 3 };
                        const statusA = getStatus(a.coupons, a.year);
                        const statusB = getStatus(b.coupons, b.year);
                        return statusOrder[statusA] - statusOrder[statusB];
                    case 'year':
                        return a.year.localeCompare(b.year);
                    default:
                        return 0;
                }
            });

            renderTable(filtered);
        }

        // Add event listener for search input
        document.getElementById('searchInput').addEventListener('keyup', function(event) {
            if (event.key === 'Enter') {
                applyFilters();
            }
        });
    </script>
</body>
</html>